7章 テスト #読書メモ #マイクロサービスアーキテクチャ
===

7.1. テストの種類
---
Brian Marickのテスト4象限。
- 受け入れテスト
- 探索的テスト
- 単体テスト
- 性質テスト

手動テストが多い場合はマイクロサービスの多くの利点を受けにくいので、マイクロサービス化する前に自動化を進めたほうが良い。

この章では自動テストについてのみ議論。
=> 手動テストも重要だが、マイクロサービスアーキテクチャのテストを考える場合は自動テストのでの違いが主だから。

7.2. テストスコープ
---
Mike Cohnのテストピラミッド。自動テストを単体、サービス、UIに分割。テストスコープが拡大するとシステムが動くという自信が向上する。テストスコープが縮小すると高速になり、分離性が向上。

単体やサービスと言った場合の用語の定義が人によって異なるので以下で議論する。UIはエンドツーエンドテストと呼ぶことにする。

### 7.2.1. 単体テスト
- 1つの機能やメソッド呼び出しを検査するテスト
- TDDの副作用として生成されるテストはこれに分類される
- サービスを起動せず外部ファイルやネットワーク接続を制限する
- この種のテストを多数用意すべき
  - 高速なフィードバックを得る
- リファクタリングの際にも重要

#### メモ
>プロパティベーステストといったテクニックで生成される種類のテストを実施するので

TDDと言えばプロパティベーステストなのだろうか？

cf. [Property-based testing: what is it?](http://blog.jessitron.com/2013/04/property-based-testing-what-is-it.html)

### 7.2.2. サービステスト
- UIを迂回してサービスを直接テストする
  - モノリシック: UIにサービスを提供する一連のクラスのテスト
  - マイクロサービス: 個々のサービスの機能のテスト

#### メモ
>高速なものもありますが、実際のデータベースに対してテストしたり、ネットワーク経由でスタブ化された下流コラボレータにアクセスする場合には、テスト時間が長くなってしまいます

それは当然だけど、トレードオフの判断基準が書いてない。

### 7.2.3. エンドツーエンドテスト
- 主にブラウザを介してGUIを実行する
- ファイルのアップロードといったユーザ対話を模倣することもある
- このテストに合格すれば自信は高まるが、マイクロサービス環境で適切に実施することは難しい

### 7.2.4. トレードオフ
スコープの大きいテストに失敗したら、今度は高速な単体テストを記述してその問題を探すようにする。目的によってさまざまなスコープのテストが必要になる。

### 7.2.5. いくつのテストを実施するか
- 経験則: ピラミッドを下るにつれて必要なテストの数が一桁増える
  - しかし重要なのは様々な種類のテストがあることを認識し、現在のバランスで問題ないか気を配ること
- 逆ピラミッド(テストスコープが大きいテストが多い状態)は避ける

7.3. サービステストの実装
---
- 単体テストの実装は単純でドキュメントもたくさんあるが、サービステストとエンドツーエンドテストは興味深い
- サービステストスイートは、下流コラボレータ用のスタブサービスを起動し、スタブサービスに接続するようにテスト対象サービスを構成する必要がある

### 7.3.1. モックかスタブか
- モック／スタブという用語
  - スタブ: テスト対象からの既知のリクエストに対し、決められたレスポンスを返す。呼び出されたかどうか自体は気にしない
  - モック: テスト中に正しい呼び出しが行われたどうかを気にする（正しくない場合はテスト失敗）
- Martin Fowlerどちらもテストダブルと呼んでいる
  - 本当か？
  - [Martin Fowlerのモックとスタブの説明](http://d.hatena.ne.jp/devbankh/20100210)
    - 状態中心／相互作用中心という視点のテストの区分があって、それぞれに必要なテストダブルの機能をスタブ／モックと呼んでいるにすぎない

#### メモ
ちなみに自分はこれまで以下のように認識していた。全然違った。
- モック: テスト対象*が*利用するモジュールのフェイク
- スタブ: テスト対象*を*利用するモジュールのフェイク

### 7.3.2. 高度なスタブサービス
- [mountebank](http://www.mbtest.org/)というスタブ／モックサーバがある

7.4. 面倒なエンドツーエンドテスト
---
- UIを介して水面下の全ての機能を動作させ、システム全体の外観を示すこと
- 全てのサービスをデプロイ
- 2つの問題
  - 他のサービスはどのバージョンを使用すべき？
  - サービスごとにパイプラインがあるがエンドツーエンドテストはどうする？
- サービスごとのパイプラインを1つのエンドツーエンドテストステージにまとめる（ファンイン: fan in）とうまくいく


### memo
>システム全体の外観を示す

とは。

7.5./7.6. エンドツーエンドテストの欠点／信頼できない脆弱なテスト
---
- テストスコープが大きくなると、可動部が増え、テスト対象の機能が壊れていないのにテスト失敗を引き起こすことがある

- 可動部が増えると
  - テストが脆弱になる
  - 決定性が下がる

- テストが信頼できなくなる
  => 逸脱の常態化(normalization of deviance)

** 逸脱の常態化(normalization of deviance) ** : 間違っているものに慣れすぎて、それを正常で問題ないと徐々に受け入れ始める。割れ窓理論と同じ？

Martin Fowler「信頼できないテストは、すぐに修正できない場合にはテストスイートから排除せよ」

場合によってはテストが簡単になるようにソフトウェアを変更することが正しい方向であることもある。

### 7.6.1. 誰がテストを書くか
複数のサービスがあり、所有するチームが複数いる場合の話。
- 経験則: エンドツーエンドテストスイートを共有コードベースにするが、共同所有にする
  - チームは自由にテストスイートにチェックインする
  - テストスイートの健全性の責任をサービスを開発したチーム間で共有しなければならない

#### メモ
>共有コードベースにするが、共同所有にする

？
>サービスを開発したチーム間

エンドツーエンドテストでは全てのサービスを連携してテストしているが、あくまで開発しているサービスはひとつ。

### 7.6.2. 実行期間
- 実行に時間がかかるため、減らさないと頻繁に実行できなくなる
- しかしテストを減らすのは難しい

### 7.6.3. 積み上がる大きな山
フィードバックサイクルが遅くなると、
1. 問題の修正に時間がかかる
1. E2Eテストを実行できる時間が減る
1. デプロイのスコープが大きくなる
1. リリースのリスクが高まる

と芋づる式に問題が出る。

対策: 小さな変更を準備ができたらできるかぎりすぐにリリースすることが重要。

### 7.6.4. メタバージョン
- E2Eテストステージでは、変更を加えたサービス以外のサービスが連携してテストをするため、全体のバージョン付けをして一緒にリリースしたくなりがち
  - これを採用すると、複数サービスを同時に変更してデプロイすることを許すことになる

マイクロサービスの主な利点の1つである、他のサービスとは独立して単独でサービスをデプロイできる能力を失うことになるし、サービスが結合する。独立してデプロイするようにしていればサービスの結合に気づけるが、一緒にデプロイしていると気付くこともできない。

7.7. ストーリーではなくジャーニーをテストする
---
やるなら複雑なシステムでも2桁までのテスト。高価値な「ジャーニー」のみテストする。

### メモ
ジャーニーとは？

7.8. 救いとなるコンシューマ駆動テスト
---
CDC(コンシューマ駆動契約): プロデューサに対するコンシューマのエクスペクテーションを定義。
サービスを利用するサービスがコンシューマ。利用される側がプロデューサ。
プロデューサのチームとコンシューマのチームに共同で作業に当たらせる。

### 7.8.1 Pact
Pactというオープンソースのコンシューマ駆動テストツールがある。

### 7.8.2 対話について
コンシューマとプロデューサ間の対話が非常に重要。CDCによって対話の焦点を明らかにする。

7.9. エンドツーエンドテストを使用すべきか
---
ほとんどの場合は徐々にE2Eテストの必要性はなくなる。代わりにCDC。
ただ、リリースサイクルが遅くなっても本番前に全ての欠陥をなくすことに全力を尽くさなくてはいけない環境もある。その場合はどのくらいの量のE2Eテストを本当に実施するのかよく検討する。

7.10. 本番リリース後のテスト
---
デプロイ前のテストで障害の可能性をゼロにすることはできない。

### 7.10.1 デプロイとリリースの分離/7.10.2 カナリアリリース
#### スモークテストスイート
デプロイが正常にできたか確認するテスト。デプロイ時に自動で走るべき。

#### ブルーグリーンデプロイメント
1. 新しいバージョンのサービスを、前のバージョンを稼働させたままデプロイ（トラフィックは流さない）
1. 新しいバージョンをスモークテスト
1. 新しいバージョンにトラフィックを流す
1. エラーが出たら前のバージョンにフォールバックさせる
1. うまく行ったら完全に切り替える

#### カナリアリリース
前のバージョンと並行して新しいバージョンのサービスを稼働させ、新しいバージョンには前のバージョンへのトラフィックの一部、または一部のコピーを流し、性能面等で期待通りかを確認する。複数バージョンのサービスが長期間共存する可能性がある事、頻繁にトラフィックの割合を変更することがブルーグリーンデプロイとの違い。

###  7.10.3 MTBFよりMTTRか
テストを増やさなくともデプロイプロセスの改善によってMTTRを改善することができる。ただしMTBF改善にかけるコストとのトレードオフである。

7.11. 機能横断テスト
---
非機能要件より機能横断要件(CFR)のほうが的確。
CFRのテストは4象限の性質テストに分類され、これもピラミッドに従う必要がある。

### 7.11.1 性能テスト
マイクロサービスアーキテクチャは動作速度が遅い。動機呼び出しのチェーンの一部が性能悪化すると大きな影響を与える可能性がある。そのため性能テストはモノリシックシステムの場合よりはるかに重要。
開発序盤は十分なテスト対象がないため性能テストは後回しにされがちだが良くない。
